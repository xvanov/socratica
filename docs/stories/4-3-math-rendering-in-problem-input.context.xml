<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>4</epicId>
    <storyId>3</storyId>
    <title>Math Rendering in Problem Input</title>
    <status>drafted</status>
    <generatedAt>2025-11-03</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/4-3-math-rendering-in-problem-input.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>student</asA>
    <iWant>to see math notation rendered when I type or paste problem text</iWant>
    <soThat>I can verify my problem input is correct</soThat>
    <tasks>
      <task id="1" ac="1,3">Create MathPreview component for problem input</task>
      <task id="2" ac="1,2,5">Integrate MathPreview into TextInput component</task>
      <task id="3" ac="2,5">Implement real-time rendering with debouncing</task>
      <task id="4" ac="4">Test common algebra notation rendering</task>
      <task id="5" ac="3">Ensure preview positioning and styling</task>
      <task id="6" ac="1-5">Testing and verification</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">Problem input field shows preview of rendered math</criterion>
    <criterion id="2">Real-time rendering as user types LaTeX syntax</criterion>
    <criterion id="3">Preview appears below or beside input field</criterion>
    <criterion id="4">Handles common algebra notation (variables, exponents, fractions)</criterion>
    <criterion id="5">Preview updates dynamically</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/epics.md" title="Epic Breakdown" section="Epic 4: Math Rendering - Story 4.3">
        Story 4.3 acceptance criteria: Problem input field shows preview of rendered math, real-time rendering as user types LaTeX syntax, preview appears below or beside input field, handles common algebra notation, preview updates dynamically.
      </doc>
      <doc path="docs/architecture.md" title="Architecture Document" section="ADR-005: KaTeX for Math Rendering">
        Decision to use KaTeX instead of MathJax for faster rendering, smaller bundle size, and sufficient algebra support. KaTeX provides react-katex package for React integration.
      </doc>
      <doc path="docs/architecture.md" title="Architecture Document" section="Epic 4: Math Rendering">
        Math renderer components stored in components/math-renderer/ directory. MathDisplay component for inline math, MathBlock component for block math. KaTeX CSS imported in root layout.
      </doc>
      <doc path="docs/architecture.md" title="Architecture Document" section="Project Structure">
        Components organized by feature/epic in components/ directory. Math renderer components in components/math-renderer/. Problem input components in components/problem-input/.
      </doc>
      <doc path="docs/PRD.md" title="Product Requirements Document" section="Goalpost 4: Math Rendering">
        Display equations properly using LaTeX rendering. Clean mathematical notation display in chat interface. Support for mathematical expressions in both input and output.
      </doc>
      <doc path="docs/stories/4-1-latex-rendering-library-integration.md" title="Story 4.1 Draft" section="Dev Notes">
        MathDisplay and MathBlock components to be created in Story 4.1 provide foundation for math rendering. KaTeX configuration in lib/math-renderer/katex-config.ts should be reused.
      </doc>
      <doc path="docs/stories/4-2-math-rendering-in-chat-messages.md" title="Story 4.2 Draft" section="Dev Notes">
        LaTeX parser utility created in lib/math-renderer/latex-parser.ts for detecting and parsing LaTeX syntax. MessageContent component demonstrates parsing mixed text/math content. Components can be reused for problem input preview.
      </doc>
      <doc path="docs/stories/1-1-text-input-interface.md" title="Story 1.1" section="Dev Notes">
        TextInput component exists at components/problem-input/TextInput.tsx with full functionality. Component uses React hooks for state management, includes validation, accessibility features, and Tailwind CSS styling.
      </doc>
      <doc path="docs/test-specifications.md" title="Test Specifications" section="Test Strategy Overview">
        Test pyramid: Unit tests (40%), Component tests (30%), Integration tests (20%), E2E tests (10%). Tests verify acceptance criteria, are meaningful and simple. Use Vitest and React Testing Library.
      </doc>
    </docs>
    <code>
      <file path="socratica/components/problem-input/TextInput.tsx" kind="component" symbol="TextInput" lines="1-164" reason="Existing text input component that needs to be enhanced with math preview. Component has textarea element (lines 99-118), state management with useState (lines 19-21), validation integration (lines 49-60), and accessibility features (lines 113-117). MathPreview component should be integrated below or beside this textarea." />
      <file path="socratica/lib/utils/validation.ts" kind="utility" symbol="validateProblemText" lines="19-48" reason="Validation utility function used by TextInput component. MathPreview integration should not interfere with validation display and error handling." />
      <file path="socratica/components/chat/MessageInput.tsx" kind="component" symbol="MessageInput" lines="19-240" reason="Similar textarea component pattern used in chat interface. Reference for textarea styling patterns and state management. MathPreview pattern can be applied similarly." />
    </code>
    <dependencies>
      <ecosystem name="node">
        <package name="react" version="19.2.0" />
        <package name="react-dom" version="19.2.0" />
        <package name="next" version="16.0.1" />
        <package name="typescript" version="^5" />
        <package name="tailwindcss" version="^4" />
        <package name="katex" reason="Required for math rendering (Story 4.1 dependency)" />
        <package name="react-katex" reason="Required for React integration (Story 4.1 dependency)" />
        <package name="vitest" version="^1.1.0" reason="Testing framework" />
        <package name="@testing-library/react" version="^15.0.0" reason="Component testing" />
        <package name="@testing-library/jest-dom" version="^6.1.5" reason="DOM testing utilities" />
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="pattern">
      Components must follow Tailwind CSS v4 utility classes for styling. MathPreview should match TextInput styling patterns (border colors, padding, spacing).
    </constraint>
    <constraint type="pattern">
      Math renderer components stored in components/math-renderer/ directory. MathPreview component should follow same patterns as MathDisplay and MathBlock from Story 4.1.
    </constraint>
    <constraint type="dependency">
      Story 4.1 must be completed first (provides MathDisplay and MathBlock components). Story 4.2 should be completed first (provides LaTeX parser utility for reuse).
    </constraint>
    <constraint type="performance">
      Real-time rendering must use debouncing (300ms delay) to prevent excessive renders. Update preview immediately on first render, debounce subsequent updates while typing.
    </constraint>
    <constraint type="accessibility">
      Math content must be accessible to screen readers. ARIA labels required for mathematical expressions. Preview should be announced to screen readers when updated.
    </constraint>
    <constraint type="responsive">
      Preview positioning: Mobile (&lt; 640px) below input field, Desktop (≥ 640px) beside input field. Use Tailwind CSS responsive classes (sm:, md:, lg:).
    </constraint>
    <constraint type="testing">
      Tests must verify acceptance criteria explicitly. Use Vitest and React Testing Library. Component tests should verify rendering, debouncing, responsive positioning, and accessibility.
    </constraint>
    <constraint type="integration">
      MathPreview integration must preserve all existing TextInput functionality (submit, validation, etc.). Preview should not interfere with input field layout or validation display.
    </constraint>
  </constraints>

  <interfaces>
    <interface name="MathPreviewProps" kind="component-props" signature="interface MathPreviewProps { value: string; className?: string; }" path="socratica/components/math-renderer/MathPreview.tsx" />
    <interface name="TextInputProps" kind="component-props" signature="interface TextInputProps { onSubmit?: (value: string) => void; placeholder?: string; value?: string; onValueChange?: (value: string) => void; }" path="socratica/components/problem-input/TextInput.tsx" />
    <interface name="latex-parser" kind="utility-function" signature="parseLaTeX(text: string): ParsedSegment[]" path="socratica/lib/math-renderer/latex-parser.ts" reason="LaTeX parser utility from Story 4.2. Parses text to detect inline math ($...$) and block math ($$...$$) expressions. Returns parsed segments with text and math expressions." />
  </interfaces>

  <tests>
    <standards>
      Testing follows TDD methodology with test pyramid: Unit tests (40%), Component tests (30%), Integration tests (20%), E2E tests (10%). Use Vitest for test execution and React Testing Library for component testing. Tests verify acceptance criteria explicitly, are meaningful and simple, run fast (&lt; 1s for unit tests), and are independent. Tests are located in component __tests__ directories matching component structure.
    </standards>
    <locations>
      <location>socratica/components/math-renderer/__tests__/MathPreview.test.tsx</location>
      <location>socratica/components/problem-input/__tests__/TextInput.test.tsx</location>
      <location>socratica/lib/math-renderer/__tests__/latex-parser.test.ts</location>
    </locations>
    <ideas>
      <idea ac="1">Test MathPreview component renders math preview when LaTeX syntax detected</idea>
      <idea ac="1">Test MathPreview integrated into TextInput component displays preview below/beside input field</idea>
      <idea ac="2">Test preview updates as user types LaTeX syntax</idea>
      <idea ac="2">Test debouncing prevents excessive renders (verify 300ms delay)</idea>
      <idea ac="3">Test preview positioning: below on mobile (&lt; 640px), beside on desktop (≥ 640px)</idea>
      <idea ac="4">Test common algebra notation: variables ($x$, $y$), exponents ($x^2$), fractions ($\frac{a}{b}$)</idea>
      <idea ac="5">Test preview updates dynamically when input value changes</idea>
      <idea ac="5">Test preview clears when input is cleared</idea>
      <idea general="true">Test MathPreview handles malformed LaTeX gracefully with error fallback</idea>
      <idea general="true">Test MathPreview accessibility (screen readers, ARIA labels, keyboard navigation)</idea>
      <idea general="true">Test MathPreview responsive design (mobile, tablet, desktop)</idea>
      <idea general="true">Test MathPreview performance (debouncing prevents excessive renders)</idea>
      <idea general="true">Integration test: Verify math preview works in TextInput component</idea>
      <idea general="true">Integration test: Verify math preview works in main interface</idea>
    </ideas>
  </tests>
</story-context>




